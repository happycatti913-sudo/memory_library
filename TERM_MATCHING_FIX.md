# 术语扫描与匹配修复说明

## 问题诊断

在"翻译流程"中的"术语扫描与确认"功能里，扫描到的项目术语无法与库里的术语相匹配，导致"备选1_系统术语"列总是空的。

### 根本原因

原代码在第 1069 行使用了过于简单的术语匹配策略：

```python
alt1 = sys_term_map.get(src_term) or sys_term_map_lower.get(src_term.lower())
```

这种方法存在的问题：

1. **精确匹配过于严格**
   - 库中的术语: "糖尿病" → 预期匹配
   - 扫描出的术语: "糖尿病 " (有尾部空格) → **无法匹配**

2. **大小写处理不完整**
   - 只有第二级的小写匹配
   - 没有规范化处理多余空格

3. **缺少容错机制**
   - 没有处理中文空格（\u3000）
   - 没有处理特殊字符差异
   - 没有处理复合词的部分匹配

4. **没有匹配梯度**
   - 只有"全对"或"不对"两种结果
   - 缺少备选匹配方案

---

## 实施的修复

### 修复1：添加术语规范化函数

**位置**：`1127.py` 第 553-567 行

```python
def _normalize_term(term: str) -> str:
    """
    规范化术语用于匹配：
    1. 去除前后空格
    2. 转小写
    3. 移除多余空格和特殊字符（包括中文空格）
    """
```

**改进点**：
- ✓ 处理英文空格、中文空格（\u3000）和其他空格字符
- ✓ 对纯中文术语自动移除内部空格
- ✓ 统一转小写处理

### 修复2：添加智能术语匹配函数

**位置**：`1127.py` 第 569-612 行

```python
def _find_term_in_map(src_term: str, term_map: dict[str, str]) -> str | None:
```

**匹配策略（按优先级）**：

1. **精确匹配** - 完全相同
   - 输入："糖尿病" → 库中："糖尿病" ✓

2. **不区分大小写匹配** - 大小写不同
   - 输入："Type 2 Diabetes" → 库中："type 2 diabetes" ✓

3. **规范化后匹配** - 空格或格式差异
   - 输入："糖尿病 " → 规范化为"糖尿病" → 库中："糖尿病" ✓
   - 输入："Type  2  Diabetes" → 规范化为"type 2 diabetes" ✓

4. **子串匹配** - 复合词部分匹配
   - 输入："心肌梗死" → 库中："心肌梗死" ✓

### 修复3：更新术语扫描逻辑

**位置**：`1127.py` 第 1117-1140 行

将原来的：
```python
alt1 = sys_term_map.get(src_term) or sys_term_map_lower.get(src_term.lower())
```

改为：
```python
# 使用改进的匹配函数查找库中的术语
alt1 = _find_term_in_map(src_term, sys_term_map)
```

---

## 测试验证

已通过所有测试用例（13/13 通过）：

### 测试场景1：基本中文术语匹配
```
✓ '糖尿病' → 'diabetes'
✓ '糖尿病 ' (尾部空格) → 'diabetes'
✓ ' 糖尿病' (首部空格) → 'diabetes'
```

### 测试场景2：英文术语不区分大小写
```
✓ 'Type 2 Diabetes' → 'T2DM'
✓ 'type 2 diabetes' → 'T2DM'
✓ 'TYPE 2 DIABETES' → 'T2DM'
✓ 'Type  2  Diabetes' (多余空格) → 'T2DM'
```

### 测试场景3：中文复杂术语
```
✓ '心肌梗死' → 'MI'
✓ '心  肌  梗  死' (内部多余空格) → 'MI'
✓ '脑卒中' → 'stroke'
```

---

## 使用影响

### 用户体验改进

在"术语扫描与确认"功能中：

**修复前**：
- 扫描出术语后，"备选1_系统术语"列通常为空
- 用户看不到库中已有的翻译
- 需要手动填写"最终译"

**修复后**：
- 扫描出术语后，"备选1_系统术语"会自动填充库中的匹配术语
- 用户可直接使用已有的翻译
- 提高翻译一致性，加快工作流程

### 容错能力

现在可以正确处理：
- 前后空格差异
- 中英文空格差异
- 大小写差异
- 内部多余空格

---

## 验证方式

运行测试脚本：
```bash
python test_term_matching.py
```

在翻译流程中测试：
1. 进入一个项目
2. 确保术语库中有术语
3. 点击"① DeepSeek 抽取术语"
4. 检查"备选1_系统术语"列是否填充了匹配的术语

---

## 性能考虑

- 规范化函数：O(n) - 字符串处理
- 匹配函数：O(m) - m为词库大小，因为使用多级策略，实际很快
- 缓存：术语表使用5分钟缓存，减少数据库查询

---

## 相关代码位置

| 功能 | 文件 | 行号 |
|------|------|------|
| 规范化函数 | 1127.py | 553-567 |
| 匹配函数 | 1127.py | 569-612 |
| 使用位置 | 1127.py | 1125 |
| 测试脚本 | test_term_matching.py | - |

---

## 下一步建议

1. 定期检查术语库中是否有重复或歧义的术语定义
2. 考虑为常见的术语变体添加别名机制
3. 可选：添加术语匹配得分显示，让用户了解匹配质量
